---
import CopyIcon from "./CopyIcon.astro";
---

<div class="space-y-4 mt-10 max-w-[850px] px-8 mx-auto">
  <!-- Header -->
  <header class="text-center mb-10">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">üîç URL Inspector</h1>
    <p class="text-gray-600">Analyze and inspect any URL with full details</p>
  </header>

  <!-- Form -->
  <form id="url-form" class="space-x-4">
    <div class="flex flex-col gap-2 w-full">
      <input
        id="url-input"
        name="url"
        class="border border-gray-300 px-4 py-2 w-full rounded"
        placeholder="Enter a URL..."
      />
      <button
        type="submit"
        class="bg-[#0c3b5c] text-white text-sm px-4 py-2 rounded hover:bg-[#2a99c9] mt-1 hover:cursor-pointer transition-colors duration-300"
      >
        Inspect
      </button>
    </div>
  </form>

  <!-- Report -->
  <section id="report" class="hidden mt-10">
    <div>
      <strong
        id="url-encoded-label"
        class="text-gray-900 text-sm uppercase tracking-wide"
      >
      </strong>
    </div>

    <div
      class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 mt-2 relative group shadow-sm transition-shadow hover:shadow-md"
    >
      <span
        id="url-encoded-value"
        class="break-all text-gray-800 text-sm leading-relaxed select-all"
      ></span>

      <div
        class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
      >
        <button
          id="url-encoded-button"
          class="bg-white hover:bg-gray-100 border border-gray-300 px-2 py-1 rounded-md shadow-sm hover:shadow-md transition-all duration-200"
          aria-label="Copy to clipboard"
        >
          <CopyIcon />
        </button>
      </div>
    </div>
  </section>

  <!-- Query Params Table-->
  <section id="query-params" class="space-y-4 mt-10">
    <strong class="text-gray-800">Query Parameters</strong>
    <table
      class="table-auto border-collapse border border-gray-300 text-sm w-full mt-2"
    >
      <thead>
        <tr>
          <th class="border px-4 py-2">Key</th>
          <th class="border px-4 py-2">Raw Value</th>
        </tr>
      </thead>
      <tbody id="query-params-table-body"></tbody>

      <p id="query-params-no-results">No query parameters found.</p>
    </table>
  </section>

  <!-- Error -->
  <div id="error" class="text-red-500"></div>
</div>

<script type="module">
  const form = document.getElementById("url-form");
  const input = document.getElementById("url-input");
  const report = document.getElementById("report");
  const queryParams = document.getElementById("query-params");
  const errorDiv = document.getElementById("error");
  const urlEncodedLabel = document.getElementById("url-encoded-label");
  const urlEncodedValue = document.getElementById("url-encoded-value");
  const urlEncodedButton = document.getElementById("url-encoded-button");
  const utmsTableBody = document.getElementById("query-params-table-body");
  const utmsNoResults = document.getElementById("query-params-no-results");

  const utmsRowStyles = ["border", "px-4", "py-2"];

  const processUrl = (raw) => {
    try {
      const encoded = encodeURIComponent(raw);
      const decoded = decodeURIComponent(raw);
      const isEncoded = decoded !== raw;
      const url = isEncoded ? new URL(decoded) : new URL(raw);

      // Saving last url for future session
      localStorage.setItem(lastUrlStorageKey, url);

      // Clear error div because url is valid
      errorDiv.textContent = "";

      // Set url encoded and decoded values
      if (isEncoded) {
        urlEncodedLabel.textContent = "URL Decoded";
        urlEncodedValue.textContent = decoded;
      } else {
        urlEncodedLabel.textContent = "URL Encoded";
        urlEncodedValue.textContent = encoded;
      }

      // Copy value to clipboard on click button
      urlEncodedButton.addEventListener("click", (e) => {
        e.stopPropagation();
        navigator.clipboard.writeText(url.href);
      });

      // Show report section
      report.classList.remove("hidden");

      const params = Array.from(url.searchParams.entries());
      if (params.length > 0) {
        // Remove "no results message"
        utmsNoResults.classList.add("hidden");

        // Remove current query-params
        utmsTableBody.replaceChildren();

        // We add each query param to the table
        for (const param of params) {
          const trElement = document.createElement("tr");

          // First column
          const tdKeyElement = document.createElement("td");
          tdKeyElement.innerText = param[0];
          tdKeyElement.classList.add(...utmsRowStyles);
          // Second column
          const tdValueElement = document.createElement("td");
          tdValueElement.innerText = param[1];
          tdValueElement.classList.add(...utmsRowStyles);

          trElement.appendChild(tdKeyElement);
          trElement.appendChild(tdValueElement);

          utmsTableBody.appendChild(trElement);
        }
      } else {
        // Show no results message
        utmsNoResults.classList.remove("hidden");
      }

      // Show query-params section
      queryParams.classList.remove("hidden");
    } catch (err) {
      console.log("error", err);

      errorDiv.textContent = "Invalid URL";

      // Hide report and query-params section
      report.classList.add("hidden");
      queryParams.classList.add("hidden");
    }
  };

  const lastUrlStorageKey = "last_url";
  const lastUrl = localStorage.getItem(lastUrlStorageKey);
  if (lastUrl) {
    input.value = lastUrl;
    processUrl(lastUrl);
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const raw = input.value.trim();
    processUrl(raw);
  });
</script>
